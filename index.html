<html>
<head>
<title>Risovach</title>
<script src="color_picker_2.0/color_picker.js"></script>
<script src="util.js"></script>
<script src="history.js"></script>
<script src="image_transformer.js"></script>
<script src="paint.js"></script>


<script>

function log(text) {div_log.innerHTML+=text+"</br>";}

var paint;
window.onload = function() {
	var rc = canvas.getContext("2d");
	//я сделаю свой консоль с логированием и эксепшенами
	try {
		paint = new Paint(canvas);
	} catch(e) {log(e);}
	var img_transf = new ImageTransformer(
		paint, 0, /*server data from*/"h1ji3-pi-black_small.jpg"/*server data to*/, //http://www.raspberrypi.org/wp-content/uploads/2011/11/h1ji3-pi-black.jpg
		function() {paint.refresh();});
	paint.setLayerObj(0, img_transf);
	
	
	//создание кнопок
	for (var i=0; i<paint.layer.length; i++) {
		var b = document.createElement('button');
		//вообще, так как-то криво. зато просто и работает
		paint.layer[i].style.width  = "128px";
		paint.layer[i].style.height = "64px";
		b.appendChild(paint.layer[i]); //хейтер прямого доступа? замени на paint.getLayerBuffer(i)
		b.onclick = (function(i) { return function() {paint.setLayer(i);} })(i);
		buttons.appendChild(b);
		buttons.appendChild(document.createElement('br'));
	}
	
	var p = new ColorPicker(picker, "color_picker_2.0/");
	p.setRGB(0,0,0);
	p.onchange = function() {
		color.style.background = this.getHTML();
	};
	p.onfinalchange = function() {
		paint.brushSetColor(this.getHTML());
	};
	paint.onColorPick = function(c) {p.setRGB(c[0]/255, c[1]/255, c[2]/255)}
}

function send() {
	var xhr = new XMLHttpRequest();
	xhr.open('POST', "", true);
	xhr.onreadystatechange = function() {
		if (xhr.readyState != 4) return;
		alert(xhr.responseText);
		if (xhr.status == 200) alert("Щас перезагружусь");
		window.location.reload()
	}
	xhr.send(canvas.toDataURL());
}

</script>



</head>
<body style="background-color:#101010;">
<object id="wtPlugin" type="application/x-wacomtabletplugin" WIDTH=1 HEIGHT=1 style="position:absolute; left:100px; top:100px">
	<!-- <param name="onload" value="pluginLoaded" /> -->
</object>
<table>
	<tr>
		<td><canvas id="canvas" style="z-index: 2; margin-left:64px; margin-top:32px;
				                       border: 1px solid #000; background:url(back.png);"
				width=800 height=400>Обновите браузер</canvas></td>
		<td><div id="buttons"></div>
		<button onclick="paint.redoAll(paint.layer_cur);">Redo all</button>
		<button onclick="paint.merge(1);">Merge</button>
		<br>
		<button onclick="paint.toolSet(paint.TOOL_BRUSH);">Brush</button>
		<button onclick="paint.toolSet(paint.TOOL_ERASER);">Eraser</button>
		<button onclick="paint.toolSet(paint.TOOL_PICKER);">Picker</button>
		<button onclick="send()">Send</button></td>
		<td>
		<div id="picker"></div>
		<div id="color" style="width:64; height:64; outline:1px solid white;"></div>
		</td>
	</tr>
</table>

<div id="div_log" style="color:white;"></div>
</body>
</html>
